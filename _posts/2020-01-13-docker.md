---
layout: post
title:  "Everything I Know About Docker"
date:   2020-01-13 10:37:11 -0500
categories: Infrastructure
---
All my notes regarding Docker that I've gathered so far.

## Docker
[Using Docker to Run a Simple Nginx Server - Myriatek - Medium](https://medium.com/myriatek/using-docker-to-run-a-simple-nginx-server-75a48d74500b)

Docker is a containerization tool. There are three fundamental parts to Docker: the Docker Registry, Docker Client, and Docker Host.

**Bind Mount**: File or directory on host machine is mounted to a container. This file or directory is referenced by its full relative path, while volumes create a new directory within Dockerâ€™s storage on the host machine.


**Volume**: Method of persisting data generated by Docker containers. Volumes are managed completely by Docker, while bind mounts are dependent on the directory structure of the host machine. **Contained within Docker storage.**
- Easy to migrate
- Managed using Docker CLI or Docker API
- Work on both Linux and Windows. 
- Can be safely shared using multiple containers.

There are two types of volumes: One type maps files or directories to those inside the container and the other serves only to persist files or directories (named volumes).

**Containers:** Subset of virtualization technology. Shares kernel and libraries of the OS while using a virtualized namespace to restrict the container's access.

Virtual machines provide hardware virtualization, while containers provide OS-level virtualization. Containers don't have much to do with hypervisors or hardware -- instead, containers share the existing kernel of the OS.

**Hypervisor**: Also known as a virtual machine monitor, this is computer software, firmware, or hardware that creates and runs virtual machines. The name stems from the term **supervisor**, the kernel fof an OS - the hypervisor is the supervisor of the supervisor.

**docker run**: This is the command used to run a docker container. There are a whole bunch of flags that this command uses to describe how to run the container:
1. -d flag: Determines if the container runs in a "detached" mode or "foreground" mode. Containers in detached mode exit when the root process that runs the container exits or the docker daemon exits, whichever is first.
  In foreground mode, docker run can start the process in the container and attac

``` bash
docker run --rm -it -p 8080:80 simple-nginx
```
8080:80 - bind port 80 of the container to port 8080 of the host (http)
rm - remove the container once execution ends

``` bash
COPY hom* /mydir/        # adds all files starting with "hom"
COPY hom?.txt /mydir/    # ? is replaced with any single character, e.g., "home.txt"
```
Copy copies files with names matching a certain pattern to the filesystem of the container. 

If you build and run a Docker and the Jenkins slave fails, there may be a hanging container. Instead, building and then aws s3 sync avoids this issue because the container isn't run.

### Docker-compose
Define and run multi-container Docker applications. Compose uses YAML files to configure the application's services.

Generally, we see Compose as a three-step process:
1. Define app's environment wth a Dockerfile so it may be reproduced anywhere.
2. Define services that make up the app in docker-compose.yml so they can be run together in an isolated environment.
3. Run docker-compose up to start Compose.

Note: Entrypoint has issues with relative paths, but CMD does not.

## Kubernetes
Kubernetes is a container orchestration tool.
**Cluster:** Set of machines, called **nodes**, running containerized applications managed by Kubernetes. Each cluster has at least one worker and one master. Master nodes manage the worker nodes, which host different components of the application.

#### Master Components
Typically, one machine runs all instances of the master component.

**kube-apiserver**: Exposes the Kubernetes API, the frontend to the control plane. Built to scale horizontally.

**Control Plane**: Container orchestration layer exposing API, interfaces to define, deploy, and manage lifecycle.

**etcd**: Key-value store using Kubes' backing store for all cluster data. Should back up data stored here.

**kube-scheduler**: Selects nodes for new pods to run on.

**kube-controller-manager**: Runs controllers.

**Controller:** Regulates state of a system (ndoes, replication, endpoints, service account & token)

**cloud-controller-manager**: Runs controllers that interact with underlying cloud providers.

#### Node Components
**kubelet**: Agent that runs on each node in a cluster = ensures containers are running in a pod. 
**kube-proxy**: Network proxy.
**Container Runtime**: Usually Docker.

